---
标题: 使用 Liberty 现代化运行时 - 在 OCP 4.x 上使用 OpenShift Pipelines 进行部署
描述: 本节介绍如何使用 Tekton (OpenShift Pipelines) CI/CD 管道将应用程序部署到 Red Hat OpenShift 4.3。下图显示了管道的流程，该流程从开发人员将其代码签入 Git 开始，并以应用程序部署在构建命名空间中结束。
---


<PageDescription>

## Summary
<AnchorLinks small>
  <AnchorLink>Overview</AnchorLink>
  <AnchorLink>Prerequisites</AnchorLink>
  <AnchorLink>Getting the project repository</AnchorLink>
  <AnchorLink>Create application database</AnchorLink>
  <AnchorLink>Create the build project</AnchorLink>
  <AnchorLink>Import the Tekton resources</AnchorLink>
  <AnchorLink>Run the pipeline</AnchorLink>
  <AnchorLink>View the pipeline logs</AnchorLink>
  <AnchorLink>Validate the application</AnchorLink>
</AnchorLinks>

## Overview
本节介绍如何使用 OpenShift Pipelines CI/CD 管道将应用程序部署到 Red Hat OpenShift 4.3+。下图显示了管道的流程，该流程从开发人员将其代码签入 Git 开始，并以应用程序部署在构建命名空间中结束。
</PageDescription>

这是一个非常简单的管道，用于演示构建 Liberty 应用程序并将其部署到 OpenShift 所需的基本步骤

The diagram below shows the following flow:

- 1) A developer commits code to the `application repository`

- 2) A webhook starts a `tekton pipeline` running in the `build` project

- 3) A `tekton task` clones the application source code (4) from the application repository, uses `Maven` to compile and test the application before using `buildah` to create a `Docker image` which is pushed to the docker registry (5)

- 6) A `tekton task` deploys the `application` to the local namespace using the image from the `docker registry` 
- (7)

  ![Pipeline](images/tekton-flow.jpg)

## 部署应用程序
  以下步骤将在 WebSphere Liberty 容器中将现代化的 Customer Order Services 应用程序部署到 Red Hat OpenShift 集群。

### 先决条件
您将需要以下内容:

- [Git CLI](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
- Red Hat OpenShift Container Platfrom 4.3+ with Cluster Admin permissions
- [oc CLI](https://docs.openshift.com/container-platform/3.11/cli_reference/get_started_cli.html)
- DB2 Database
- [Red Hat OpenShift Pipelines Operator]
- [Tekton CLI](https://github.com/tektoncd/cli)

### 获取项目存储库
您可以从其主 GitHub 存储库页面克隆存储库，并为该版本的应用程序签出相应的分支。

```
git clone https://github.com/ibm-cloud-architecture/appmod-liberty-tekton.git
cd appmod-liberty-tekton
```

### 创建应用程序数据库
As said in the prerequisites section above, the Customer Order Services application uses uses DB2 as its database.

If you want to use a pre-configured DB2 database in a container in OpenShift, use the instructions provided [here](db2)

Alternatively, if you have a DB2 server that you want to use, follow these steps to create the appropriate database, tables and data the application needs to:

- Copy the createOrderDB.sql and initialDataSet.sql files you can find in the Common directory of this repository over to the db2 host machine (or git clone the repository) in order to execute them later.

- ssh into the db2 host

- Change to the db2 instance user: `su {database_instance_name}``

- Start db2: `db2start`

- Create the ORDERDB database: `db2 create database ORDERDB`

- Connect to the ORDERDB database: `db2 connect to ORDERDB`

- Execute the createOrderDB.sql script you copied over in step 1 in order to create the appropriate tables, relationships, primary keys, etc: `db2 -tf createOrderDB.sql`

- Execute the initialDataSet.sql script you copied over in step 1 to populate the ORDERDB database with the needed initial data set: `db2 -tf initialDataSet.sql`

If you want to re-run the scripts, please make sure you drop the databases and create them again.

### 创建构建项目
Create the project that will be used for the Tekton pipeline and the initial deployment of the application.

Issue the command shown below to create the project:
```
oc new-project cos-liberty-tekton
```

### 导入 Tekton 资源
Import the Tekton `Tasks`, `Pipeline` and `PipelineResources` in to the project using the commands shown below:

```
cd tekton/tekton-only
oc apply -f gse-apply-manifests-pvc-task.yaml
oc apply -f gse-buildah-pvc-task.yaml
oc apply -f gse-build-deploy-pvc-pipeline.yaml
oc apply -f gse-build-pipeline-resources.yaml
```

### 运行 pipeline
The recommended way to trigger the pipeline would be via a webhook and [Tekton Trigger](https://github.com/tektoncd/triggers) but for simplicity the command line can be used. Issue the command below to trigger the pipeline:

```
tkn pipeline start  gse-build-deploy-pvc-pipeline -n cos-liberty-tekton
```

When prompted, accept the default `git-source` value as shown below:

  ![Pipeline](images/tekton-only/start-1.jpg)

When prompted, accept the default `docker-image` value as shown below:

  ![Pipeline1](images/tekton-only/start-2.jpg)

### 查看 pipeline logs
- In the OpenShift Container Platform UI, change to the **Developer** view, select the `cos-liberty-tekton` project and then select **Pipelines**. Click on the **Last Run**

  ![Pipeline](images/tekton-only/run-1.jpg)

- 选择日志

  ![Pipeline Logs](images/tekton-only/run-2.jpg)

- The pipeline will execute and the logs will be displayed

  ![Pipeline Logs](images/tekton-only/run-3.jpg)

- Once both the `gse-build` and `gse-apply-manifests` steps are complete, the pipeline is finished.

### 验证应用
Now that the pipeline is complete, validate the Customer Order Services application is deployed and running in `cos-liberty-tekton` project

- In the OpenShift Console, navigate to **Topology** view and click on the `cos-liberty` DeploymentConfig to view deployment details, including `Pods` `Services` and `Routes`

#### 拓扑
  ![Deployment](images/tekton-only/validate-1.jpg)

- 从此视图中，您还可以查看应用程序的路由。注意 URL 是 <application_name>-<project_name>.<ocp cluster url>。在这种情况下，项目名称是cos-liberty-tekton

  ![Route](images/tekton-only/route.jpg)

-  添加/CustomerOrderServicesWeb到浏览器中的 URL 末尾以访问应用程序

  ![Dev Running](images/liberty-deploy/dev-running.jpg)

- 使用username: rbarcia和登录应用程序password: bl0wfish


