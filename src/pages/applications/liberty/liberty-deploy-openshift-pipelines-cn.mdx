标题	描述
使用 Liberty 现代化运行时 - 在 OCP 4.x 上使用 OpenShift Pipelines 进行部署
本节介绍如何使用 Tekton (OpenShift Pipelines) CI/CD 管道将应用程序部署到 Red Hat OpenShift 4.3。下图显示了管道的流程，该流程从开发人员将其代码签入 Git 开始，并以应用程序部署在构建命名空间中结束。
export const Title = () => ( 使用 Liberty 现代化运行时

在 OCP 4.x 上使用 OpenShift Pipelines 进行部署
);
概括
概述 先决条件 获取项目存储库 创建应用程序数据库 创建构建项目 导入 Tekton 资源 运行管道 查看管道日志 验证应用程序
概述
本节介绍如何使用 OpenShift Pipelines CI/CD 管道将应用程序部署到 Red Hat OpenShift 4.3+。下图显示了管道的流程，该流程从开发人员将其代码签入 Git 开始，并以应用程序部署在构建命名空间中结束。

这是一个非常简单的管道，用于演示构建 Liberty 应用程序并将其部署到 OpenShift 所需的基本步骤。Liberty - Deploy using Cloud Native Toolkit部分描述了更完整的管道

下图显示了以下流程：

开发人员将代码提交给 application repository
一个 webhooktekton pipeline在build项目中开始运行
Atekton task从应用程序存储库中克隆应用程序源代码 (4)，用于Maven编译和测试应用程序，然后再buildah用于创建Docker image推送到 docker 注册表的应用程序(5)
A使用(7) 中的镜像将tekton task部署application到本地命名空间docker registry
管道

部署应用程序
以下步骤将在 WebSphere Liberty 容器中将现代化的 Customer Order Services 应用程序部署到 Red Hat OpenShift 集群。

先决条件
您将需要以下内容：

命令行界面
具有集群管理员权限的 Red Hat OpenShift Container Platfrom 4.3+
命令行界面
DB2 数据库
[红帽 OpenShift 管道操作员]
泰克顿命令行界面
获取项目存储库
您可以从其主 GitHub 存储库页面克隆存储库，并为该版本的应用程序签出相应的分支。

git clone https://github.com/ibm-cloud-architecture/appmod-liberty-tekton.git
cd appmod-liberty-tekton
创建应用程序数据库
正如上面的先决条件部分所述，Customer Order Services 应用程序使用 DB2 作为其数据库。

如果要在 OpenShift 的容器中使用预先配置的 DB2 数据库，请使用此处提供的说明

或者，如果您有要使用的 DB2 服务器，请按照以下步骤创建应用程序所需的适当数据库、表和数据：

将您可以在此存储库的 Common 目录中找到的 createOrderDB.sql 和 initialDataSet.sql 文件复制到 db2 主机（或 git clone 存储库），以便稍后执行它们。

ssh 进入 db2 主机

更改为 db2 实例用户：`su {database_instance_name}`

启动 db2： db2start

创建 ORDERDB 数据库： db2 create database ORDERDB

连接到 ORDERDB 数据库： db2 connect to ORDERDB

执行您在步骤 1 中复制的 createOrderDB.sql 脚本，以创建适当的表、关系、主键等： db2 -tf createOrderDB.sql

执行您在步骤 1 中复制的 initialDataSet.sql 脚本，以使用所需的初始数据集填充 ORDERDB 数据库： db2 -tf initialDataSet.sql

如果要重新运行脚本，请确保删除数据库并重新创建它们。

创建构建项目
创建将用于 Tekton 管道和应用程序初始部署的项目。

发出如下所示的命令来创建项目：

oc new-project cos-liberty-tekton
导入 Tekton 资源
导入Tekton的Tasks，Pipeline并且PipelineResources在使用该命令的项目如下图所示：

cd tekton/tekton-only
oc apply -f gse-apply-manifests-pvc-task.yaml
oc apply -f gse-buildah-pvc-task.yaml
oc apply -f gse-build-deploy-pvc-pipeline.yaml
oc apply -f gse-build-pipeline-resources.yaml
运行管道
触发管道的推荐方法是通过 webhook 和Tekton Trigger，但为简单起见，可以使用命令行。发出以下命令以触发管道：

tkn pipeline start  gse-build-deploy-pvc-pipeline -n cos-liberty-tekton
出现提示时，接受默认git-source值，如下所示：

管道

出现提示时，接受默认docker-image值，如下所示：

管道1

查看管道日志
在 OpenShift Container Platform UI 中，切换到Developer视图，选择cos-liberty-tekton项目，然后选择Pipelines。单击上次运行

管道

选择日志

管道日志

管道将执行并显示日志

管道日志

一旦gse-build和gse-apply-manifests步骤都完成，管道就完成了。

验证应用程序
现在管道已完成，验证客户订单服务应用程序已部署并在cos-liberty-tekton项目中运行

在 OpenShift 控制台中，导航到Topology视图并单击cos-libertyDeploymentConfig 以查看部署详细信息，包括Pods Services和Routes
拓扑
部署

从此视图中，您还可以查看应用程序的路由。注意 URL 是 <application_name>-<project_name>.<ocp cluster url>。在这种情况下，项目名称是cos-liberty-tekton

路线

添加/CustomerOrderServicesWeb到浏览器中的 URL 末尾以访问应用程序

开发运行

使用username: rbarcia和登录应用程序password: bl0wfish
